---
export interface Props {
  src: string;
  alt: string;
  class?: string;
  width?: number;
  height?: number;
  loading?: 'lazy' | 'eager';
  quality?: 'auto' | number;
  format?: 'auto' | 'webp' | 'jpg' | 'png';
  crop?: 'fill' | 'fit' | 'scale' | 'crop';
  gravity?: 'auto' | 'face' | 'center';
  priority?: boolean; // For LCP optimization
}

const {
  src,
  alt,
  class: className = '',
  width = 800,
  height,
  loading = 'lazy',
  quality = 'auto',
  format = 'auto',
  crop = 'fill',
  gravity = 'auto',
  priority = false
} = Astro.props;

// Check if it's a Cloudinary URL or a local reference that can be optimized via Fetch
const isCloudinaryUrl = src && (src.includes('cloudinary.com') || src.includes('res.cloudinary.com'));
const isLocalPath = src && src.startsWith('/') && !src.startsWith('//');

// In development, we cannot use Cloudinary Fetch API for local images because localhost is not publicly accessible.
// We only optimize local images in production.
const isDev = import.meta.env.DEV;
const shouldOptimizeLocal = isLocalPath && !isDev;

let optimizedSrc = src || '';
let srcSet = '';
let avifSrcSet = '';
let webpSrcSet = '';
let isOptimizable = isCloudinaryUrl || shouldOptimizeLocal;

if (!src) {
  isOptimizable = false;
}

if (isOptimizable) {
  try {
    let baseUrl = '';
    let publicId = '';

    if (isCloudinaryUrl) {
      // Handle existing Cloudinary upload URLs
      const urlParts = src.split('/upload/');
      if (urlParts.length === 2) {
        baseUrl = urlParts[0] + '/upload/';
        const pathAfterUpload = urlParts[1];
        
        // Robustly separate transformations from public ID
        // If there's a slash, the first part might be transformations (e.g., w_200/v123/path)
        // or just folders/version (e.g., v123/folder/path). 
        // Cloudinary handles transformations separately if they are separated by commas.
        // For simplicity, we assume everything after the last transformation segment or version is the public ID.
        const pathSegments = pathAfterUpload.split('/');
        
        // Find the index where transformations end (usually the last segment is the filename/publicId)
        // We'll keep the folders and version if present.
        publicId = pathAfterUpload; 
        
        // Remove existing transformations if they are in the first segment and contain underscores/commas
        if (pathSegments.length > 1 && (pathSegments[0].includes('_') || pathSegments[0].includes(','))) {
           publicId = pathSegments.slice(1).join('/');
        }
      }
    } else if (shouldOptimizeLocal) {
      // Handle local paths via Cloudinary Fetch API (Only in Production)
      baseUrl = 'https://res.cloudinary.com/dphbnwjtx/image/fetch/';
      publicId = `https://relofinder.ch${src}`;
    }

    if (baseUrl && publicId) {
      // Build transformation parameters
      const transforms: string[] = [];
      const qualityParam = width <= 640 ? 'q_auto:eco' : 'q_auto:good';
      transforms.push(qualityParam);
      
      if (height) {
        transforms.push(`w_${width},h_${height},c_${crop}`);
      } else {
        transforms.push(`w_${width},c_${crop}`);
      }
      
      if (gravity && gravity !== 'auto') {
        transforms.push(`g_${gravity}`);
      }
      
      transforms.push('dpr_auto');
      transforms.push('fl_progressive');
      transforms.push('fl_immutable_cache');
      
      const baseTransformString = transforms.join(',');
      const sizes = [320, 384, 640, 768, 1024, 1280];
      const relevantSizes = sizes.filter(size => size <= width * 1.5);
      
      avifSrcSet = relevantSizes.map(size => {
        return `${baseUrl}f_avif,${baseTransformString.replace(/w_\d+/, `w_${size}`)}/${publicId} ${size}w`;
      }).join(', ');
      
      webpSrcSet = relevantSizes.map(size => {
        return `${baseUrl}f_webp,${baseTransformString.replace(/w_\d+/, `w_${size}`)}/${publicId} ${size}w`;
      }).join(', ');
      
      srcSet = relevantSizes.map(size => {
        const formatParam = format === 'auto' ? 'f_auto' : `f_${format}`;
        return `${baseUrl}${formatParam},${baseTransformString.replace(/w_\d+/, `w_${size}`)}/${publicId} ${size}w`;
      }).join(', ');
      
      const formatParam = format === 'auto' ? 'f_auto' : `f_${format}`;
      optimizedSrc = `${baseUrl}${formatParam},${baseTransformString}/${publicId}`;
    }
  } catch (error) {
    console.warn('Cloudinary optimization failed:', error);
    optimizedSrc = src;
  }
}

// Enhanced sizes attribute
const responsiveSizes = priority 
  ? '(max-width: 640px) 100vw, (max-width: 768px) 90vw, (max-width: 1024px) 80vw, 70vw'
  : '(max-width: 384px) 364px, (max-width: 640px) 90vw, (max-width: 768px) 80vw, (max-width: 1024px) 70vw, 60vw';

const finalLoading = priority ? 'eager' : loading;
const fetchPriority = priority ? 'high' : 'auto';
---

<!-- Enhanced picture element for better format support and performance -->
{isOptimizable ? (
  <picture>
    <!-- AVIF format for modern browsers (best compression) -->
    {avifSrcSet && (
      <source 
        srcset={avifSrcSet} 
        sizes={responsiveSizes}
        type="image/avif"
      />
    )}
    
    <!-- WebP format for wide browser support -->
    {webpSrcSet && (
      <source 
        srcset={webpSrcSet} 
        sizes={responsiveSizes}
        type="image/webp"
      />
    )}
    
    <!-- Fallback image with optimized srcset -->
    <img
      src={optimizedSrc}
      srcset={srcSet || undefined}
      sizes={srcSet ? responsiveSizes : undefined}
      alt={alt}
      class={className}
      loading={finalLoading}
      fetchpriority={fetchPriority}
      width={width}
      height={height}
      decoding="async"
      onerror="this.src='https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&w=800&q=80'"
    />
  </picture>
) : (
  <!-- Non-Cloudinary images -->
  <img
    src={optimizedSrc}
    alt={alt}
    class={className}
    loading={finalLoading}
    fetchpriority={fetchPriority}
    width={width}
    height={height}
    decoding="async"
    onerror="this.src='https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&w=800&q=80'"
  />
)} 