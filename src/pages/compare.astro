---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { supabase } from "../lib/supabase";
import { Check, X, ArrowLeft } from "lucide-react";

const { searchParams } = Astro.url;
const idsParam = searchParams.get("ids") || "";
const ids = idsParam.split(",").filter(Boolean);

// Fetch data
const { data: relocators } = await supabase
    .from("relocators")
    .select(
        "id, name, tier, rating, seo_summary, slug, services, regions_served, logo",
    );

// Helper to find data
const findCompany = (idOrSlug: string) => {
    const norm = idOrSlug.toLowerCase();

    const dbMatch = relocators?.find(
        (r) =>
            r.id.toString() === norm ||
            r.slug?.toLowerCase() === norm ||
            r.name.toLowerCase().includes(norm),
    );

    if (!dbMatch) return null;

    return {
        slug: dbMatch.slug || "#",
        name: dbMatch.name || "Unknown",
        logo: dbMatch.logo,
        description: dbMatch.seo_summary,
        rating: dbMatch.rating || 4.5,
        tier: dbMatch.tier || "standard",
        services: dbMatch.services || [],
        regions: dbMatch.regions_served || [],
        verified: dbMatch.tier === "preferred" || dbMatch.tier === "partner",
    };
};

const selectedCompanies = ids.map(findCompany).filter(Boolean);

// Features to compare
const features = [
    { label: "Verified Partner", key: "verified", type: "boolean" },
    { label: "Rating", key: "rating", type: "rating" },
    { label: "Service Coverage", key: "services", type: "list" },
    { label: "Regions", key: "regions", type: "list" },
];
---

<Layout
    title="Compare Agencies | ReloFinder"
    description="Compare top relocation agencies in Switzerland side-by-side."
>
    <div class="bg-slate-50 min-h-screen py-24">
        <div class="container mx-auto px-4">
            <div class="mb-8">
                <a
                    href="/companies"
                    class="inline-flex items-center gap-2 text-slate-500 hover:text-slate-900 transition-colors mb-4 text-sm font-medium"
                >
                    <ArrowLeft className="w-4 h-4" /> Back to Directory
                </a>
                <h1 class="text-3xl font-bold text-slate-900">
                    Compare Agencies
                </h1>
            </div>

            {
                selectedCompanies.length === 0 ? (
                    <div class="bg-white p-12 rounded-2xl border border-slate-200 text-center">
                        <p class="text-slate-500 mb-6">
                            No agencies selected for comparison.
                        </p>
                        <a
                            href="/companies"
                            class="inline-block bg-[#FF6F61] text-white px-6 py-3 rounded-xl font-bold uppercase tracking-widest text-xs hover:bg-[#ff5a4d] transition-colors"
                        >
                            Browse Directory
                        </a>
                    </div>
                ) : (
                    <div class="overflow-x-auto pb-6">
                        <table class="w-full bg-white rounded-2xl border border-slate-200 border-separate border-spacing-0 overflow-hidden shadow-sm">
                            <thead>
                                <tr class="bg-slate-50/50">
                                    <th class="p-6 text-left w-1/4 border-b border-r border-slate-200 min-w-[200px]">
                                        <span class="text-xs font-bold uppercase tracking-widest text-slate-400">
                                            Features
                                        </span>
                                    </th>
                                    {selectedCompanies.map((c) => (
                                        <th class="p-6 text-left border-b border-slate-200 min-w-[250px] relative group hover:bg-slate-50 transition-colors">
                                            <div class="space-y-4">
                                                <div class="h-12 flex items-center">
                                                    {c.logo &&
                                                    !c.logo.includes(
                                                        "placehold",
                                                    ) ? (
                                                        <img
                                                            src={c.logo}
                                                            alt={c.name}
                                                            class="h-10 max-w-full object-contain"
                                                        />
                                                    ) : (
                                                        <span class="text-lg font-bold text-slate-900">
                                                            {c.name}
                                                        </span>
                                                    )}
                                                </div>
                                                <div>
                                                    <a
                                                        href={`/companies/${c.slug}`}
                                                        class="text-lg font-bold text-slate-900 hover:text-[#FF6F61] transition-colors block mb-1"
                                                    >
                                                        {c.name}
                                                    </a>
                                                    <p class="text-xs text-slate-500 font-normal line-clamp-2">
                                                        {c.description}
                                                    </p>
                                                </div>
                                                {c.tier === "preferred" && (
                                                    <div class="inline-flex items-center gap-1 bg-black text-white px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-widest">
                                                        <Check className="w-3 h-3 text-[#FF6F61]" />{" "}
                                                        Verified
                                                    </div>
                                                )}
                                            </div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {/* Rating Row */}
                                <tr>
                                    <td class="p-6 border-b border-r border-slate-100 font-semibold text-slate-700 text-sm">
                                        Client Rating
                                    </td>
                                    {selectedCompanies.map((c) => (
                                        <td class="p-6 border-b border-slate-100">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl font-bold text-slate-900">
                                                    {c.rating}
                                                </span>
                                                <div class="flex text-yellow-400 text-sm">
                                                    {"â˜…".repeat(
                                                        Math.round(c.rating),
                                                    )}
                                                </div>
                                            </div>
                                        </td>
                                    ))}
                                </tr>

                                {/* Services Row */}
                                <tr>
                                    <td class="p-6 border-b border-r border-slate-100 font-semibold text-slate-700 text-sm align-top">
                                        Services
                                    </td>
                                    {selectedCompanies.map((c) => (
                                        <td class="p-6 border-b border-slate-100 align-top">
                                            <ul class="space-y-2">
                                                {c.services.map((s) => (
                                                    <li class="flex items-start gap-2 text-sm text-slate-600">
                                                        <Check className="w-4 h-4 text-green-500 shrink-0 mt-0.5" />
                                                        <span class="capitalize">
                                                            {s.replace(
                                                                /-/g,
                                                                " ",
                                                            )}
                                                        </span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </td>
                                    ))}
                                </tr>

                                {/* Regions Row */}
                                <tr>
                                    <td class="p-6 border-b border-r border-slate-100 font-semibold text-slate-700 text-sm align-top">
                                        Regions
                                    </td>
                                    {selectedCompanies.map((c) => (
                                        <td class="p-6 border-b border-slate-100 align-top">
                                            <div class="flex flex-wrap gap-2">
                                                {c.regions.map((r) => (
                                                    <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs capitalize">
                                                        {r}
                                                    </span>
                                                ))}
                                            </div>
                                        </td>
                                    ))}
                                </tr>

                                {/* CTA Row */}
                                <tr>
                                    <td class="p-6 border-r border-slate-100" />
                                    {selectedCompanies.map((c) => (
                                        <td class="p-6">
                                            <a
                                                href={`/companies/${c.slug}`}
                                                class="block w-full text-center bg-slate-900 text-white py-3 rounded-xl font-bold text-sm hover:bg-[#FF6F61] transition-colors"
                                            >
                                                View Profile
                                            </a>
                                        </td>
                                    ))}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                )
            }
        </div>
    </div>
</Layout>
