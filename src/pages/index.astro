---
import { 
  MapPin, 
  Building2, 
  Star, 
  ArrowRight, 
  Home, 
  ChevronDown,
  FileText,
  Download,
  Feather,
  Search
} from 'lucide-react';
import '../styles/global.css';
import '../styles/alpine-clarity.css';
import { getAgenciesCarouselData } from '../utils/agenciesCarouselData';
import SEOHead from '../components/common/SEOHead.astro';
import UniversalContactModal from '../components/common/UniversalContactModal.tsx';
import '../lib/expose-modal-stores.client.ts';
import MarketIntelligence from '../components/home/MarketIntelligence.astro';
import Navbar from '../components/layout/Navbar.astro';
import Footer from '../components/layout/Footer.astro';
import HeroSearch from '../components/home/HeroSearch.tsx';
import heroMountains from '../assets/images/home/alpine-sunset-hero.jpg';
import swissMapImg from '../assets/swiss-map-filled.png';
import swissMapWhiteOrange from '../assets/images/home/swiss-map-white-orange.jpg';

// data fetch
const carouselAgencies = await getAgenciesCarouselData(3);
const topAgencies = carouselAgencies.map(agency => ({
  name: agency.name,
  rating: agency.avg_rating > 0 ? agency.avg_rating : 5.0, // Visual fallback
  count: agency.reviews_count > 0 ? agency.reviews_count : 12,
  analystNote: agency.seo_summary || agency.description || "Verified relocation partner.",
  tags: agency.services.slice(0, 2),
  logo: agency.logo_url || "/images/placeholder-logo.svg",
  slug: agency.slug, // used for linking
  isPreferred: agency.verified || agency.name.includes("Welcome Service")
}));

const cantons = [
  { name: "Zurich", code: "ZH", slug: "zurich" },
  { name: "Geneva", code: "GE", slug: "geneva" },
  { name: "Basel-Stadt", code: "BS", slug: "basel-stadt" },
  { name: "Zug", code: "ZG", slug: "zug" },
  { name: "Vaud", code: "VD", slug: "vaud" },
  { name: "Bern", code: "BE", slug: "bern" },
  { name: "Lucerne", code: "LU", slug: "lucerne" },
  { name: "St. Gallen", code: "SG", slug: "st-gallen" }
];

const services = [
  { name: "Housing Search", slug: "housing-search" },
  { name: "Visa & Immigration", slug: "visa-immigration" },
  { name: "Moving Logistics", slug: "moving-logistics" },
  { name: "School Search", slug: "school-search" }
];

const faqs = [
  {
    q: "How much does a relocation agent cost in Switzerland?",
    a: "Basic home search packages start around CHF 2,500, while full-service relocation management can range from CHF 5,000 to CHF 12,000 depending on family size and services required."
  },
  {
    q: "Can I move to Switzerland without a job?",
    a: "EU/EFTA citizens can move for 3 months to look for work. Non-EU citizens generally need a signed employment contract or proof of independent wealth/retirement to obtain a residence permit."
  },
  {
    q: "How long does the Swiss visa process take?",
    a: "For EU citizens, permits are often issued within 2-4 weeks. For non-EU nationals, the work permit approval process typically takes 8-12 weeks involving both cantonal and federal approval."
  }
];
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <SEOHead 
      title="Compare Best Relocation Agencies Switzerland | ReloFinder"
      description="Find and compare verified Swiss relocation agencies. Get free quotes, read analyst summaries, and download our 2025 Cost Benchmark Guide."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* Swiss Passport Style Canton Cards */
        .canton-card-bg {
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            color: #F1F5F9; /* slate-100 */
            opacity: 0.4;
            line-height: 1;
        }
    </style>
</head>
<body class="font-sans text-slate-600 bg-[#F9FAFB] antialiased">

    <!-- 1. Split Header -->
    <Navbar />

    <!-- 2. Premium Hero: "Editorial Luxury" (Light Version) -->
    <section class="relative min-h-[90vh] flex items-center justify-center overflow-hidden bg-slate-950 group">
        
        <!-- Background Visual -->
        <div class="absolute inset-0 z-0">
            <!-- Level 1: Static Grayscale Base (Always visible, acts as the shadow layer) -->
            <img 
                src={heroMountains.src} 
                alt="Swiss Alps Shadow" 
                class="absolute inset-0 w-full h-full object-cover grayscale brightness-90"
            />
            
            <!-- Level 2: Color Reveal Overlay (Sunset Skies) - Fades in over 2s -->
            <img 
                src={heroMountains.src} 
                alt="Swiss Alps Sunset" 
                class="absolute inset-0 w-full h-full object-cover opacity-0 group-hover:opacity-100 transition-opacity duration-[2000ms] ease-in-out z-10 brightness-90"
            />
            
            <!-- Level 3: Atmosphere Gradient (Static shadow for text readability) -->
            <div class="absolute inset-0 bg-gradient-to-b from-slate-950/40 via-transparent to-slate-950 z-20 pointer-events-none"></div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-20 mt-32">
            
            <h1 class="text-5xl md:text-7xl font-bold tracking-tighter text-white mb-8 leading-[1.1] text-balance font-serif">
                Find Your Swiss <br/>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-slate-200 via-white to-slate-400">Relocation Expert.</span>
            </h1>
            
            <p class="text-xl md:text-2xl text-slate-400 font-light max-w-2xl mx-auto mb-16 leading-relaxed">
                The gold standard directory for moving to Switzerland. <br class="hidden md:block"/> Connect with verified agencies that value your privacy.
            </p>

            <!-- Conversion Box -->
            <div class="max-w-4xl mx-auto relative z-30 text-left transform hover:scale-[1.01] transition-transform duration-500">
                <HeroSearch client:load />
            </div>
        </div>


    </section>

    <!-- 3. "Editorial" Agency Cards (Powered by Real Data) -->
    <section class="py-24 bg-white border-y border-slate-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-end mb-16">
                <div>
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800 mb-3">Top Rated Agencies</h2>
                    <p class="text-slate-500 text-lg">Selected based on verification status and independent analysis.</p>
                </div>
                <a href="/companies" class="hidden md:flex items-center gap-2 text-[#FF6F61] font-semibold hover:text-[#e05548] transition-colors border-b-2 border-[#FF6F61]/20 pb-1 hover:border-[#FF6F61]">
                    View All Agencies <ArrowRight className="w-4 h-4" />
                </a>
            </div>

            <div class="grid md:grid-cols-3 gap-10">
                {topAgencies.map((agency) => (
                    <div class="bg-white rounded-xl border border-slate-200 p-0 transition-all duration-500 hover:shadow-2xl hover:shadow-slate-200/50 hover:-translate-y-1 group h-full flex flex-col">
                        
                        <!-- Card Header -->
                        <div class="p-8 pb-4">
                            <div class="flex items-center justify-between mb-6">
                                <div class="h-14 w-auto min-w-[60px] max-w-[180px] bg-white rounded-lg border border-slate-100 px-3 py-1 flex items-center justify-center shadow-sm relative overflow-hidden">
                                     {agency.logo ? (
                                        <img src={agency.logo} class="h-full w-auto object-contain grayscale opacity-70 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-300 transform group-hover:scale-105" alt={`${agency.name} Logo`} />
                                      ) : (
                                        <span class="text-xs font-bold text-slate-300">LOGO</span>
                                      )}
                                </div>
                                <div class="flex flex-col items-end">
                                     <div class="flex text-yellow-400 mb-1">
                                        <Star className="w-4 h-4 fill-current" />
                                        <Star className="w-4 h-4 fill-current" />
                                        <Star className="w-4 h-4 fill-current" />
                                        <Star className="w-4 h-4 fill-current" />
                                        <Star className="w-4 h-4 fill-current" />
                                    </div>
                                    <span class="text-xs font-semibold text-slate-400">{agency.count} Verified Reviews</span>
                                </div>
                            </div>
                            <h3 class="font-bold text-slate-800 text-xl mb-2 flex items-center gap-2">
                              {agency.name}
                              {agency.isPreferred && <span class="bg-slate-100 text-slate-600 border border-slate-200 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wider font-bold">Preferred</span>}
                            </h3>
                        </div>

                        <!-- Analyst Note - Editorial Style -->
                        <div class="bg-stone-50 border-y border-slate-100 px-8 py-6 flex-grow">
                            <div class="flex items-center gap-2 mb-3">
                                <Feather className="w-3 h-3 text-slate-400" />
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Analyst Summary</span>
                            </div>
                            <p class="text-slate-700 leading-relaxed font-serif italic text-lg line-clamp-4">
                                "{agency.analystNote}"
                            </p>
                        </div>

                        <!-- Footer Actions -->
                        <div class="p-8 pt-6 mt-auto">
                            <div class="flex flex-wrap gap-2 mb-6 h-14 overflow-hidden content-start">
                                {agency.tags.map(tag => (
                                    <span class="px-3 py-1 bg-white text-slate-600 text-xs font-medium rounded-full border border-slate-200">
                                        {tag}
                                    </span>
                                ))}
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <a href={`/companies/${agency.slug}`} class="flex items-center justify-center w-full py-3 rounded-lg border border-slate-200 text-slate-700 font-semibold text-sm hover:bg-slate-50 hover:border-slate-300 transition-all duration-300">
                                    View Profile
                                </a>
                                <button onclick={`window.universalOpenModal({ page: 'home', topic: '${agency.name}' })`} class="flex items-center justify-center w-full py-3 rounded-lg bg-slate-800 text-white font-semibold text-sm hover:bg-slate-700 transition-all duration-300">
                                    Get Quote
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
            
            <div class="mt-12 text-center md:hidden">
                <a href="/companies" class="text-[#FF6F61] font-semibold">View All Agencies &rarr;</a>
            </div>
        </div>
    </section>

    <!-- 4. Interactive Regions Map -->
    <section class="py-32 bg-white overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid lg:grid-cols-2 gap-16 items-center">
                
                <!-- Content Side -->
                <div class="relative z-20">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600 text-[11px] font-bold uppercase tracking-widest mb-8">
                        <MapPin className="w-3 h-3" />
                        Nationwide Coverage
                    </div>
                    
                    <h2 class="text-4xl md:text-5xl font-bold text-slate-900 mb-6 tracking-tight leading-tight">
                        Find Experts <br/>
                        <span class="text-[#FF6F61]">Region by Region.</span>
                    </h2>
                    
                    <p class="text-slate-500 text-lg leading-relaxed mb-10 max-w-md">
                        From the banking hubs of Zurich and Geneva to the tax-efficient cantons of Zug and Schwyz. Connect with specialists who know the local housing market inside out.
                    </p>

                    <div class="flex flex-wrap gap-3">
                        {cantons.slice(0, 4).map(canton => (
                            <a href={`/regions/${canton.slug}`} class="px-5 py-3 rounded-lg border border-slate-200 text-slate-700 font-semibold hover:border-[#FF6F61] hover:text-[#FF6F61] transition-colors bg-white shadow-sm">
                                {canton.name}
                            </a>
                        ))}
                        <a href="/regions" class="px-5 py-3 rounded-lg bg-slate-50 text-slate-500 font-semibold hover:bg-slate-100 transition-colors flex items-center gap-2">
                            View All <ArrowRight className="w-4 h-4" />
                        </a>
                    </div>
                </div>

                <!-- Map Side -->
                <div class="relative w-full max-w-2xl mx-auto group mt-8 lg:mt-0 perspective-1000">
                     <!-- Map Image Container (Rounded Box + No Zoom) -->
                     <div class="relative w-full aspect-[4/3] flex items-center justify-center rounded-3xl overflow-hidden shadow-2xl border border-slate-100 bg-white">
                        
                        <img 
                             src={swissMapWhiteOrange.src} 
                             alt="Swiss Active Regions" 
                             class="w-full h-full object-cover grayscale opacity-90 transition-all duration-700 ease-in-out group-hover:grayscale-0 group-hover:opacity-100"
                        />
                        
                        <!-- Hover Overlay Effect (Brand Shine) -->
                        <div class="absolute inset-0 bg-gradient-to-tr from-[#FF6F61]/20 via-transparent to-transparent opacity-0 group-hover:opacity-60 transition-opacity duration-700 pointer-events-none mix-blend-overlay"></div>
                     </div>
                </div>

            </div>
        </div>
    </section>

    <!-- 5. Lead Magnet "Compare Agencies" -->
    <section class="bg-white py-24">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-3xl p-10 md:p-16 flex flex-col md:flex-row items-center justify-between gap-12 border border-slate-100 shadow-2xl relative overflow-hidden text-center md:text-left">
                
                <div class="relative z-10 max-w-xl">
                    <span class="block text-[#FF6F61] text-[10px] font-bold uppercase tracking-[0.2em] mb-4">Verified Directory</span>
                    <h2 class="text-3xl md:text-5xl font-playfair font-bold text-slate-900 mb-6 leading-tight">
                        Compare the best <br/> <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#FF6F61] to-orange-400">relocation agencies.</span>
                    </h2>
                    <p class="text-slate-500 text-lg leading-relaxed mb-8">
                        Don't rely on random Google searches. Browse verified profiles, read client reviews, and find the perfect match for your move to Switzerland.
                    </p>
                    
                    <a href="/companies" class="inline-flex items-center gap-3 bg-[#FF6F61] text-white px-8 py-4 rounded-full font-bold uppercase tracking-widest text-xs hover:bg-[#ff5a4d] transition-all transform hover:scale-[1.02] shadow-xl shadow-[#FF6F61]/20">
                        Start Comparison
                        <ArrowRight className="w-4 h-4" />
                    </a>
                </div>

                <!-- Decorative Illustration / Icon -->
                <div class="relative z-10 hidden md:block">
                     <div class="w-24 h-24 bg-slate-50 rounded-2xl flex items-center justify-center rotate-3 shadow-lg border border-slate-100">
                        <Search className="w-10 h-10 text-[#FF6F61]" />
                     </div>
                </div>
                
                <!-- Background Decoration -->
                <div class="absolute right-0 top-0 w-1/2 h-full bg-gradient-to-l from-slate-50/50 to-transparent pointer-events-none"></div>
            </div>
        </div>
    </section>

    <!-- 6. Market Intelligence -->
    <MarketIntelligence />

    <!-- 7. LLM FAQ Section -->
    <section class="py-24 bg-white">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-10 text-center">Common Questions about Moving to Switzerland</h2>
            <div class="space-y-4">
                {faqs.map((faq, i) => (
                    <details class="group bg-[#F9FAFB] border border-slate-200 rounded-lg overflow-hidden">
                        <summary class="flex justify-between items-center p-5 cursor-pointer font-semibold text-slate-800 hover:bg-slate-100 transition-colors select-none text-lg">
                            {faq.q}
                            <ChevronDown className="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" />
                        </summary>
                        <div class="px-5 pb-6 pt-2 text-slate-600 leading-relaxed border-t border-slate-100">
                            {faq.a}
                        </div>
                    </details>
                ))}
            </div>
        </div>
    </section>

    <!-- 7. Footer -->
    <Footer theme="dark" />

    <!-- Hidden marker div - always present in DOM for MutationObserver -->
    <div id="relofinder-modal-marker" data-relofinder-modal="pending" style="display: none;" aria-hidden="true"></div>
    
    <!-- Use client:load to ensure React is ready before hydration -->
    <UniversalContactModal client:load />

    <script>
        // Tab Logic
        const tabs = document.querySelectorAll('#hero-tabs button');
        const ctaButton = document.getElementById('hero-cta') as HTMLAnchorElement;
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('bg-white', 'text-slate-800', 'border-b-2', 'border-[#FF6F61]');
                    t.classList.add('bg-slate-50', 'text-slate-500', 'border-transparent');
                });
                tab.classList.remove('bg-slate-50', 'text-slate-500', 'border-transparent');
                tab.classList.add('bg-white', 'text-slate-800', 'border-b-2', 'border-[#FF6F61]');

                const action = tab.getAttribute('data-action');
                if (action && ctaButton) {
                    ctaButton.href = action;
                }
            });
        });
    </script>

    <!-- Global Modal Functions - Synchronous Setup Before React Loads -->
    <script is:inline>
      // Initialize globals FIRST (before browser check) so functions are always defined
      if (typeof window !== 'undefined') {
        window.modalEventQueue = window.modalEventQueue || [];
        window.modalReady = false;
        window.reactHydrationFailed = false;
        
        // Define functions immediately so they're always available
        window.universalOpenModal = function(context) {
          const resolvedContext =
            context && typeof context === 'object'
              ? context
              : typeof context === 'string'
                ? { page: 'legacy', topic: context }
                : { page: 'home' };

          console.log('üìû universalOpenModal called', resolvedContext);

          if (window.modalReady && window.relofinderModalStores) {
            window.relofinderModalStores.setContext(resolvedContext);
            window.relofinderModalStores.setOpen(true);
            return;
          }

          // Queue event until React is ready
          console.log('‚è≥ Modal not ready, queuing context', resolvedContext);
          window.modalEventQueue.push({ kind: 'open', payload: resolvedContext });
        };

        const legacyModalContextMap = {
          'individual-lead-modal': { page: 'service', service: 'relocation' },
        };

        window.openModal = function(legacyContext) {
          console.log('üìû legacy openModal shim invoked with', legacyContext);

          if (typeof legacyContext === 'string') {
            const mappedContext = legacyModalContextMap[legacyContext] || { page: 'home', topic: legacyContext };
            window.universalOpenModal(mappedContext);
            return;
          }

          if (legacyContext && typeof legacyContext === 'object') {
            window.universalOpenModal(legacyContext);
            return;
          }

          window.universalOpenModal({ page: 'home' });
        };
        
        window.closeModal = function() {
          console.log('üö™ closeModal called');
          
          if (window.modalReady && window.relofinderModalStores) {
            window.relofinderModalStores.setOpen(false);
          } else {
            window.modalEventQueue.push({ kind: 'close' });
          }
        };
      }
      
      // Guard all DOM access - only run in browser (SSR-safe)
      if (typeof window === 'undefined' || typeof document === 'undefined') {
        // SSR - exit early, do nothing
      } else {
        // Initialize modal system synchronously before React loads
        window.reactLoadPromise = null;
        
        // Preload React to ensure it's ready before hydration
        if (!window.reactLoadPromise) {
          window.reactLoadPromise = new Promise((resolve) => {
            // Check if React is already loaded
            if (window.React || document.querySelector('script[src*="react"]')) {
              resolve();
              return;
            }
            
            // Wait for React to load (check every 50ms, max 5 seconds)
            let checks = 0;
            const checkReact = setInterval(() => {
              checks++;
              if (window.React || document.querySelector('script[src*="react"]') || checks > 100) {
                clearInterval(checkReact);
                resolve();
              }
            }, 50);
          });
        }
        
        // Listen for React hydration errors and set up fallback event listeners
        window.addEventListener('error', function(e) {
        if (e.message && (e.message.includes('hydrating') || e.message.includes('unstable_now'))) {
          console.error('üö® React hydration error detected:', e.message);
          window.reactHydrationFailed = true;
          
          // Set up event listeners that work even without React
          const setupFallbackListeners = () => {
            // Try to access nanostores via window (they might be exposed even if React fails)
            const checkStores = setInterval(() => {
              if (window.relofinderModalStores) {
                console.log('‚úÖ Found nanostores, setting up fallback listeners');
                clearInterval(checkStores);
                
                // Set up listeners that use nanostores directly
                window.addEventListener('openModal', function(e) {
                  if (window.relofinderModalStores && e.detail) {
                    console.log('üîî Fallback: Opening modal via nanostores', e.detail);
                    window.relofinderModalStores.setContext(e.detail);
                    window.relofinderModalStores.setOpen(true);
                  }
                });
                
                window.addEventListener('closeModal', function() {
                  if (window.relofinderModalStores) {
                    console.log('üîî Fallback: Closing modal via nanostores');
                    window.relofinderModalStores.setOpen(false);
                  }
                });
              }
            }, 100);
            
            // Stop checking after 5 seconds
            setTimeout(() => clearInterval(checkStores), 5000);
          };
          
          setupFallbackListeners();
          
          // If React fails, mark as ready anyway after a delay to process queue
          setTimeout(() => {
            if (!window.modalReady) {
              console.warn('‚ö†Ô∏è React hydration failed, forcing modal ready state');
              const marker = document.getElementById('relofinder-modal-marker');
              if (marker) {
                marker.setAttribute('data-relofinder-modal', 'ready');
              }
              window.modalReady = true;
              if (typeof window.processModalQueue === 'function') {
                window.processModalQueue();
              }
            }
          }, 2000);
        }
      }, true);
      
      const dispatchModalContext = (context) => {
        try {
          // Try to use nanostores directly if available (works even if React hasn't mounted)
          if (window.relofinderModalStores) {
            console.log('üì¶ Using nanostores directly');
            window.relofinderModalStores.setContext(context);
            window.relofinderModalStores.setOpen(true);
            return true;
          }
          
          // Fallback to event dispatch (requires React component to be mounted)
          const event = new CustomEvent('openModal', { detail: context });
          window.dispatchEvent(event);
          return true;
        } catch (error) {
          console.error('‚ùå Failed to dispatch modal context', error);
          return false;
        }
      };
      
      const dispatchCloseModal = () => {
        try {
          // Try to use nanostores directly if available
          if (window.relofinderModalStores) {
            window.relofinderModalStores.setOpen(false);
            return true;
          }
          
          // Fallback to event dispatch
          const event = new CustomEvent('closeModal');
          window.dispatchEvent(event);
          return true;
        } catch (error) {
          console.error('‚ùå Failed to dispatch close modal', error);
          return false;
        }
      };

      // Universal modal opener - queues events until React is ready
      // MUST be exposed to window OUTSIDE IIFE so it's globally accessible
      window.universalOpenModal = function(context) {
        const resolvedContext =
          context && typeof context === 'object'
            ? context
            : typeof context === 'string'
              ? { page: 'legacy', topic: context }
              : { page: 'home' };

        console.log('üìû universalOpenModal called', resolvedContext);

        if (window.modalReady) {
          dispatchModalContext(resolvedContext);
          return;
        }

        // Queue event until React is ready
        console.log('‚è≥ Modal not ready, queuing context', resolvedContext);
        window.modalEventQueue.push({ kind: 'open', payload: resolvedContext });
      };

      // Legacy compatibility for old openModal calls
      const legacyModalContextMap = {
        'individual-lead-modal': { page: 'service', service: 'relocation' },
      };

      window.openModal = function(legacyContext) {
        console.log('üìû legacy openModal shim invoked with', legacyContext);

        if (typeof legacyContext === 'string') {
          const mappedContext = legacyModalContextMap[legacyContext] || { page: 'home', topic: legacyContext };
          window.universalOpenModal(mappedContext);
          return;
        }

        if (legacyContext && typeof legacyContext === 'object') {
          window.universalOpenModal(legacyContext);
          return;
        }

        window.universalOpenModal({ page: 'home' });
      };
      
      window.closeModal = function() {
        console.log('üö™ closeModal called');
        
        if (window.modalReady) {
          dispatchCloseModal();
        } else {
          window.modalEventQueue.push({ kind: 'close' });
        }
      };
      
      // Process queued events when React component confirms readiness
      window.processModalQueue = function() {
        // Prevent double processing
        if (window.modalReady && window.modalEventQueue.length === 0) {
          return;
        }
        
        console.log('üöÄ Processing modal queue:', window.modalEventQueue.length, 'events');
        window.modalReady = true;
        
        const queuedItems = [...window.modalEventQueue];
        window.modalEventQueue = [];

        queuedItems.forEach(item => {
          if (item?.kind === 'open') {
            dispatchModalContext(item.payload);
          } else if (item?.kind === 'close') {
            dispatchCloseModal();
          }
        });
      };
      
      // MutationObserver to detect when React component mounts in DOM
      const observeReactMount = () => {
        let checkCount = 0;
        const maxChecks = 40; // 20 seconds max for mobile
        
        const checkAndProcess = () => {
          // Check both the marker div and any React-rendered markers
          const markerDiv = document.getElementById('relofinder-modal-marker');
          const reactMarker = document.querySelector('[data-relofinder-modal="ready"]');
          const marker = reactMarker || markerDiv;
          
          if (marker && marker.getAttribute('data-relofinder-modal') === 'ready' && !window.modalReady) {
            console.log('‚úÖ Modal marker detected in DOM');
            window.modalReady = true;
            if (typeof window.processModalQueue === 'function') {
              window.processModalQueue();
            }
            return true;
          }
          return false;
        };

        const observer = new MutationObserver((mutations, obs) => {
          if (checkAndProcess()) {
            obs.disconnect();
            if (checkInterval) clearInterval(checkInterval);
          }
        });

        // Start observing immediately
        observer.observe(document.body, {
          childList: true,
          subtree: true,
          attributes: true,
          attributeFilter: ['data-relofinder-modal']
        });

        // Check immediately
        if (checkAndProcess()) {
          observer.disconnect();
        }

        // Periodic check for slow devices or hydration failures
        const checkInterval = setInterval(() => {
          checkCount++;
          if (checkAndProcess()) {
            observer.disconnect();
            clearInterval(checkInterval);
          } else if (checkCount >= maxChecks) {
            // Force ready state if React never mounts (hydration failure)
            console.warn('‚ö†Ô∏è React component not detected after 20 seconds, forcing ready state');
            const markerDiv = document.getElementById('relofinder-modal-marker');
            if (markerDiv && !window.modalReady) {
              markerDiv.setAttribute('data-relofinder-modal', 'ready');
              window.modalReady = true;
              if (typeof window.processModalQueue === 'function') {
                window.processModalQueue();
              }
            }
            observer.disconnect();
            clearInterval(checkInterval);
          }
        }, 500);
      };

      // Start observing when script loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', observeReactMount);
      } else {
        observeReactMount();
      }
      } // End browser check
    </script>
</body>
</html>