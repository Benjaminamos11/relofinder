---
import { 
  MapPin, 
  Star, 
  ArrowRight, 
  ChevronDown,
  FileText,
  Feather,
  Search
} from 'lucide-react';
import '../styles/global.css';
import '../styles/alpine-clarity.css';
import { getAgenciesCarouselData } from '../utils/agenciesCarouselData';
import MarketIntelligence from '../components/home/MarketIntelligence.astro';
import HeroSearch from '../components/home/HeroSearch.tsx';
import Layout from '../layouts/Layout.astro';
import CloudinaryImage from '../components/common/CloudinaryImage.astro';

// Cache at the edge for 5 minutes, in the browser for 1 minute
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=300');

// Cloudinary Assets
const cloudinaryBase = 'https://res.cloudinary.com/dphbnwjtx/image/upload/f_auto,q_auto';
const heroLake = { src: `${cloudinaryBase}/home/swiss-lake-drone-hero` };
const heroBoutique = { src: `${cloudinaryBase}/home/swiss-boutique-hero-color` };
const heroDarkInterior = { src: `${cloudinaryBase}/home/swiss-modern-dark-interior` };
const swissMapWhiteOrange = { src: `${cloudinaryBase}/home/swiss-map-white-orange` };

// data fetch
const carouselAgencies = await getAgenciesCarouselData(3);
const topAgencies = carouselAgencies.map(agency => ({
  name: agency.name,
  rating: agency.avg_rating > 0 ? agency.avg_rating : 5.0, // Visual fallback
  count: agency.reviews_count > 0 ? agency.reviews_count : 12,
  analystNote: agency.description || agency.seo_summary || "Verified relocation partner.",
  tags: agency.services.slice(0, 2),
  logo: agency.logo_url || "/images/placeholder-logo.svg",
  slug: agency.slug, // used for linking
  isPreferred: agency.verified || agency.name.includes("Welcome Service")
}));

const cantons = [
  { name: "Zurich", code: "ZH", slug: "zurich" },
  { name: "Geneva", code: "GE", slug: "geneva" },
  { name: "Basel-Stadt", code: "BS", slug: "basel" },
  { name: "Zug", code: "ZG", slug: "zug" },
  { name: "Vaud", code: "VD", slug: "lausanne" },
  { name: "Bern", code: "BE", slug: "bern" },
  { name: "Lucerne", code: "LU", slug: "lucerne" },
  { name: "St. Gallen", code: "SG", slug: "st-gallen" }
];

const servicesArr = [
  { name: "Housing Search", slug: "housing" },
  { name: "Visa & Immigration", slug: "immigration" },
  { name: "Moving Logistics", slug: "moving-logistics" },
  { name: "School Search", slug: "education" }
];

const faqs = [
  {
    q: "How much does a relocation agent cost in Switzerland?",
    a: "Basic home search packages start around CHF 2,500, while full-service relocation management can range from CHF 5,000 to CHF 12,000 depending on family size and services required."
  },
  {
    q: "Can I move to Switzerland without a job?",
    a: "EU/EFTA citizens can move for 3 months to look for work. Non-EU citizens generally need a signed employment contract or proof of independent wealth/retirement to obtain a residence permit."
  },
  {
    q: "How long does the Swiss visa process take?",
    a: "For EU citizens, permits are often issued within 2-4 weeks. For non-EU nationals, the work permit approval process typically takes 8-12 weeks involving both cantonal and federal approval."
  }
];

const title = "Compare Best Relocation Agencies Switzerland | ReloFinder";
const description = "Find and compare verified Swiss relocation agencies. Get free quotes, read analyst summaries, and download our 2025 Cost Benchmark Guide.";

const homeSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "ReloFinder",
  "url": "https://relofinder.ch/",
  "description": description
};
---

<Layout 
  title={title} 
  description={description}
  canonical="https://relofinder.ch/"
  keywords={['relocation switzerland', 'swiss relocation services', 'moving to switzerland', 'compare relocation agencies']}
  schema={homeSchema}
>
    <!-- Premium Hero: "Editorial Luxury" (Light Version) -->
    <section class="relative min-h-[90vh] flex items-center justify-center overflow-hidden bg-slate-950 group">
        
        <!-- Background Visual -->
        <div class="absolute inset-0 z-0 bg-slate-900">
            <!-- Interactive Hero Slider: B&W by default, color reveal on hover -->
            <div id="hero-slides" class="absolute inset-0 transition-grayscale duration-[1500ms] ease-in-out grayscale group-hover:grayscale-0">
                <CloudinaryImage 
                    src={heroLake.src} 
                    alt="Lake Zurich Coastline" 
                    width={1920}
                    height={1080}
                    priority={true}
                    class="hero-slide absolute inset-0 w-full h-full object-cover transition-opacity duration-[2000ms] opacity-100"
                />
                <CloudinaryImage 
                    src={heroBoutique.src} 
                    alt="Swiss Relocation Boutique" 
                    width={1920}
                    height={1080}
                    class="hero-slide absolute inset-0 w-full h-full object-cover transition-opacity duration-[2000ms] opacity-0"
                />
                <CloudinaryImage 
                    src={heroDarkInterior.src} 
                    alt="Modern Swiss Interior" 
                    width={1920}
                    height={1080}
                    class="hero-slide absolute inset-0 w-full h-full object-cover transition-opacity duration-[2000ms] opacity-0"
                />
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-20 mt-32">
            
            <h1 class="text-5xl md:text-7xl font-bold tracking-tighter text-white mb-12 leading-[1.1] text-balance font-serif">
                Find Your Swiss <br/>
                <span class="text-slate-100">Relocation </span>
                <span class="text-white transition-colors duration-[2000ms] ease-in-out group-hover:text-[#FF6F61]">Expert.</span>
            </h1>

            <!-- Conversion Box -->
            <div class="max-w-5xl mx-auto relative z-30 text-left transform hover:scale-[1.01] transition-transform duration-500 mt-12">
                <HeroSearch client:only="react" />
            </div>
        </div>
    </section>

    <!-- Agency Cards Section -->
    <section class="py-24 bg-white border-y border-slate-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-end mb-16">
                <div>
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800 mb-3">Top Rated Agencies</h2>
                    <p class="text-slate-500 text-lg">Selected based on verification status and independent analysis.</p>
                </div>
                <a href="/companies" class="hidden md:flex items-center gap-2 text-[#FF6F61] font-semibold hover:text-[#e05548] transition-colors border-b-2 border-[#FF6F61]/20 pb-1 hover:border-[#FF6F61]">
                    View All Agencies <ArrowRight className="w-4 h-4" />
                </a>
            </div>

            <div class="grid md:grid-cols-3 gap-10">
                {topAgencies.map((agency) => (
                    <div class="bg-white rounded-xl border border-slate-200 p-0 transition-all duration-500 hover:shadow-2xl hover:shadow-slate-200/50 hover:-translate-y-1 group h-full flex flex-col">
                        
                        <!-- Card Header -->
                        <div class="p-8 pb-4">
                            <div class="flex items-center justify-between mb-6">
                                <div class="h-14 w-auto min-w-[60px] max-w-[180px] bg-white rounded-lg border border-slate-100 px-6 py-3 flex items-center justify-center shadow-sm relative overflow-hidden">
                                     {agency.logo ? (
                                        <CloudinaryImage 
                                          src={agency.logo} 
                                          alt={`${agency.name} Logo`} 
                                          width={200}
                                          height={60}
                                          crop="fit"
                                          class="h-full w-auto object-contain grayscale opacity-70 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-300 transform group-hover:scale-105" 
                                        />
                                      ) : (
                                        <span class="text-xs font-bold text-slate-300">LOGO</span>
                                      )}
                                </div>
                                <div class="flex flex-col items-end">
                                     <div class="flex text-yellow-400 mb-1">
                                        <Star className="w-4 h-4 fill-current" />
                                        <Star className="w-4 h-4 fill-current" />
                                        <Star className="w-4 h-4 fill-current" />
                                        <Star className="w-4 h-4 fill-current" />
                                        <Star className="w-4 h-4 fill-current" />
                                    </div>
                                    <span class="text-xs font-semibold text-slate-500">{agency.count} Verified Reviews</span>
                                </div>
                            </div>
                            <h3 class="font-bold text-slate-800 text-xl mb-2 flex items-center gap-2">
                              {agency.name}
                              {agency.isPreferred && <span class="bg-slate-100 text-slate-600 border border-slate-200 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wider font-bold">Preferred</span>}
                            </h3>
                        </div>

                        <!-- Analyst Note - Editorial Style -->
                        <div class="bg-stone-50 border-y border-slate-100 px-8 py-6 flex-grow">
                            <div class="flex items-center gap-2 mb-3">
                                <Feather className="w-3 h-3 text-slate-500" />
                                <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Analyst Summary</span>
                            </div>
                            <p class="text-slate-700 leading-relaxed font-serif italic text-lg line-clamp-4">
                                "{agency.analystNote}"
                            </p>
                        </div>

                        <!-- Footer Actions -->
                        <div class="p-8 pt-6 mt-auto">
                            <div class="flex flex-wrap gap-2 mb-6 h-14 overflow-hidden content-start">
                                {agency.tags.map(tag => (
                                    <span class="px-3 py-1 bg-white text-slate-600 text-xs font-medium rounded-full border border-slate-200">
                                        {tag}
                                    </span>
                                ))}
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <a href={`/companies/${agency.slug}`} class="flex items-center justify-center w-full py-3 rounded-lg border border-slate-200 text-slate-700 font-semibold text-sm hover:bg-slate-50 hover:border-slate-300 transition-all duration-300">
                                    View Profile
                                </a>
                                <button onclick={`window.openAssessmentModal('full-package');`} class="flex items-center justify-center w-full py-3 rounded-lg bg-slate-800 text-white font-semibold text-sm hover:bg-slate-700 transition-all duration-300">
                                    Get Quote
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
            
            <div class="mt-12 text-center md:hidden">
                <a href="/companies" class="text-[#FF6F61] font-semibold">View All Agencies &rarr;</a>
            </div>
        </div>
    </section>

    <!-- Interactive Regions Map -->
    <section class="py-32 bg-white overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid lg:grid-cols-2 gap-16 items-center">
                
                <!-- Content Side -->
                <div class="relative z-20">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600 text-[11px] font-bold uppercase tracking-widest mb-8">
                        <MapPin className="w-3 h-3" />
                        Nationwide Coverage
                    </div>
                    
                    <h2 class="text-4xl md:text-5xl font-bold text-slate-900 mb-6 tracking-tight leading-tight">
                        Find Experts <br/>
                        <span class="text-[#FF6F61]">Region by Region.</span>
                    </h2>
                    
                    <p class="text-slate-600 text-lg leading-relaxed mb-10 max-w-md">
                        From the banking hubs of Zurich and Geneva to the tax-efficient cantons of Zug and Schwyz. Connect with specialists who know the local housing market inside out.
                    </p>

                    <div class="flex flex-wrap gap-3">
                        {cantons.slice(0, 4).map(canton => (
                            <a href={`/regions/${canton.slug}`} class="px-5 py-3 rounded-lg border border-slate-200 text-slate-700 font-semibold hover:border-[#FF6F61] hover:text-[#FF6F61] transition-colors bg-white shadow-sm">
                                {canton.name}
                            </a>
                        ))}
                        <a href="/regions" class="px-5 py-3 rounded-lg bg-slate-50 text-slate-600 font-semibold hover:bg-slate-100 transition-colors flex items-center gap-2">
                            View All <ArrowRight className="w-4 h-4" />
                        </a>
                    </div>
                </div>

                <!-- Map Side -->
                <div class="relative w-full max-w-2xl mx-auto group mt-8 lg:mt-0 perspective-1000">
                     <div class="relative w-full aspect-[4/3] flex items-center justify-center rounded-3xl overflow-hidden shadow-2xl border border-slate-100 bg-white">
                        <CloudinaryImage 
                             src={swissMapWhiteOrange.src} 
                             alt="Swiss Active Regions Map" 
                             width={800}
                             height={600}
                             class="w-full h-full object-cover grayscale opacity-90 transition-all duration-700 ease-in-out group-hover:grayscale-0 group-hover:opacity-100"
                        />
                        <div class="absolute inset-0 bg-gradient-to-tr from-[#FF6F61]/20 via-transparent to-transparent opacity-0 group-hover:opacity-60 transition-opacity duration-700 pointer-events-none mix-blend-overlay"></div>
                     </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Lead Magnet -->
    <section class="bg-white py-24">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-3xl p-10 md:p-16 flex flex-col md:flex-row items-center justify-between gap-12 border border-slate-100 shadow-2xl relative overflow-hidden text-center md:text-left">
                
                <div class="relative z-10 max-w-xl">
                    <span class="block text-[#FF6F61] text-[10px] font-bold uppercase tracking-[0.2em] mb-4">Verified Directory</span>
                    <h2 class="text-3xl md:text-5xl font-playfair font-bold text-slate-900 mb-6 leading-tight">
                        Compare the best <br/> <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#FF6F61] to-orange-400">relocation agencies.</span>
                    </h2>
                    <p class="text-slate-600 text-lg leading-relaxed mb-8">
                        Don't rely on random Google searches. Browse verified profiles, read client reviews, and find the perfect match for your move to Switzerland.
                    </p>
                    
                    <a href="/companies" class="inline-flex items-center gap-3 bg-[#FF6F61] text-white px-8 py-4 rounded-full font-bold uppercase tracking-widest text-xs hover:bg-[#ff5a4d] transition-all transform hover:scale-[1.02] shadow-xl shadow-[#FF6F61]/20">
                        Start Comparison
                        <ArrowRight className="w-4 h-4" />
                    </a>
                </div>

                <div class="relative z-10 hidden md:block">
                     <div class="w-24 h-24 bg-slate-50 rounded-2xl flex items-center justify-center rotate-3 shadow-lg border border-slate-100">
                        <Search className="w-10 h-10 text-[#FF6F61]" />
                     </div>
                </div>
                <div class="absolute right-0 top-0 w-1/2 h-full bg-gradient-to-l from-slate-50/50 to-transparent pointer-events-none"></div>
            </div>
        </div>
    </section>

    <MarketIntelligence />

    <!-- FAQ Section -->
    <section class="py-24 bg-white">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-10 text-center">Common Questions about Moving to Switzerland</h2>
            <div class="space-y-4">
                {faqs.map((faq) => (
                    <details class="group bg-[#F9FAFB] border border-slate-200 rounded-lg overflow-hidden">
                        <summary class="flex justify-between items-center p-5 cursor-pointer font-semibold text-slate-800 hover:bg-slate-100 transition-colors select-none text-lg">
                            {faq.q}
                            <ChevronDown className="w-5 h-5 text-slate-500 group-open:rotate-180 transition-transform" />
                        </summary>
                        <div class="px-5 pb-6 pt-2 text-slate-600 leading-relaxed border-t border-slate-100">
                            {faq.a}
                        </div>
                    </details>
                ))}
            </div>
        </div>
    </section>

    <script>
        function initHeroSlider() {
            const slides = document.querySelectorAll('.hero-slide');
            if (!slides.length) return;
            
            let currentSlide = 0;
            let intervalId;

            function nextSlide() {
                slides[currentSlide].classList.remove('opacity-100');
                slides[currentSlide].classList.add('opacity-0');
                currentSlide = (currentSlide + 1) % slides.length;
                slides[currentSlide].classList.remove('opacity-0');
                slides[currentSlide].classList.add('opacity-100');
            }

            intervalId = setInterval(nextSlide, 10000);

            // Cleanup function to stop interval when navigating away
            document.addEventListener('astro:before-swap', () => {
                if (intervalId) clearInterval(intervalId);
            }, { once: true });
        }

        // Run on initial load
        initHeroSlider();
        
        // Run on subsequent navigations
        document.addEventListener('astro:page-load', () => {
             // Avoid double initialization if the script re-runs
             // (Note: inline scripts re-run on body/head replacement, but page-load fires too. 
             // Ideally we check if it's already running or rely on cleanups. 
             // Since initHeroSlider defines local vars, calling it again is safe-ish ONLY if we cleaned up the old one.)
             initHeroSlider();
        });
    </script>
</Layout>

<style>
    .canton-card-bg {
        font-family: 'Inter', sans-serif;
        font-weight: 800;
        color: #F1F5F9; /* slate-100 */
        opacity: 0.4;
        line-height: 1;
    }
</style>