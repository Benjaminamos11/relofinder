const fs = require('fs');
const path = require('path');

const companiesDir = path.join(process.cwd(), 'src/content/companies');
const outputFile = path.join(process.cwd(), 'migration_data_fix.sql');

function parseFrontmatter(content) {
    const match = content.match(/^---\n([\s\S]*?)\n---/);
    if (!match) return null;

    const frontmatter = match[1];
    const data = {};

    const lines = frontmatter.split('\n');
    let currentKey = null;
    let currentIndent = 0;

    // Very basic YAML parser tailored for this specific extracted format
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim() || line.trim().startsWith('#')) continue;

        if (line.match(/^\s+-\s/)) continue; // Skip array items for now

        const keyMatch = line.match(/^(\s*)([a-zA-Z0-9_]+):\s*(.*)$/);
        if (keyMatch) {
            const indent = keyMatch[1].length;
            const key = keyMatch[2];
            let value = keyMatch[3].trim();

            // Remove quotes
            if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
                value = value.slice(1, -1);
            }

            if (indent === 0) {
                currentKey = key;
                data[key] = value;
            } else if (currentKey === 'address') {
                // specific handler for address object structure seen in files
                data.address = data.address || {};
                if (data[key]) delete data[key]; // cleanup
                data.address[key] = value;
            }
        }
    }
    return data;
}

function escapeSql(str) {
    if (!str) return 'NULL';
    return `'${str.replace(/'/g, "''")}'`;
}

try {
    const files = fs.readdirSync(companiesDir);
    let sqlContent = `
-- Migration: Populate Relocators Data from Markdown
-- Generated by script

`;

    files.forEach(file => {
        if (!file.endsWith('.md') || file.startsWith('_')) return;

        const content = fs.readFileSync(path.join(companiesDir, file), 'utf8');
        const data = parseFrontmatter(content);

        if (!data || !data.name) return;

        // SKIP verification boolean logic for extracting strings
        if (data.verified === 'true') data.verified = true;
        if (data.verified === 'false') data.verified = false;

        const name = data.name;

        // 1. Update RELOCATORS table
        sqlContent += `
-- Update ${name}
UPDATE relocators 
SET 
    contact_email = ${escapeSql(data.email)},
    phone_number = ${escapeSql(data.phone)},
    website = ${escapeSql(data.website)},
    founded_year = ${data.founded && !isNaN(parseInt(data.founded)) ? parseInt(data.founded) : 'NULL'},
    employee_count = ${escapeSql(data.employees)},
    address_street = ${escapeSql(data.address?.street)},
    address_city = ${escapeSql(data.address?.city)},
    address_zip = ${escapeSql(data.address?.postalCode)}
WHERE name ILIKE ${escapeSql(name)};
`;

        // 2. Insert into RELOCATOR_OFFICES if address exists
        if (data.address && data.address.city) {
            sqlContent += `
-- Insert Office for ${name}
INSERT INTO relocator_offices (relocator_id, street, city, zip, is_main)
SELECT id, ${escapeSql(data.address.street)}, ${escapeSql(data.address.city)}, ${escapeSql(data.address.postalCode)}, true
FROM relocators 
WHERE name ILIKE ${escapeSql(name)}
AND NOT EXISTS (
    SELECT 1 FROM relocator_offices WHERE relocator_id = relocators.id AND is_main = true
);
`;
        }
    });

    fs.writeFileSync(outputFile, sqlContent);
    console.log(`Generated SQL to ${outputFile}`);

} catch (err) {
    console.error('Error:', err);
}
